# 轨迹规划

## 简单曲线规划

### 关节轨迹

给定机械臂相应的关节角度q, 每一个执行电机直接运行至关节角度。
这种情况下机械臂末端轨迹在运行过程中是不确定的，但可以确保在工作区间内，因为所有关节电机的运行都只有角度限制，共同组成一个凸集。

通常将某一目标点的q及该点名称保存至某一文件内，如CSV文件。
可以直接读取该文件将机械臂运行至某一点位。

### 笛卡尔空间轨迹

在笛卡尔空间坐标下，输入为空间内的某一位姿，输出为机械臂相应的关节角q。

由于机械臂构型限制，必须考虑该点位是否在机械臂的工作区间内(逆运动学是否有解), 规划路径时只是给定几个特殊点，默认点中间的轨迹是可以到达的，暂不进行避障检测。

#### 直线轨迹

定义时间标度s：[0, 1]，初始点$q_0$， 末端点$q_1$，相对位移$\Delta q=q_1 - q_0$

则可以得到实时的角度，速度等：

$$q = \Delta q \cdot s \\
\dot q = \Delta q \cdot \dot s$$

其中s可以通过五次多项式或者S曲线定义

#### 圆弧轨迹

##### 一. 给定初始点、圆心位置（相对初始点位移）、旋转轴、旋转角，确定圆弧轨迹

这种方法不太直观，一般用于旋转轴固定的情况，比如旋转门把手。

初点： $S(R_s, P_s)$

圆心相对初点向量：$\vec{SC_1}$ ， 其中$C_1$为给定点位置，$C$为实际圆心位置

旋转轴：$\hat Z$

旋转角：$\theta$

1. 确定实际中心点$C$坐标

    给定的圆心并不一定是在实际的圆心位置上。

    将自由向量$\hat Z$移至圆心$C$上，此时，有该空间内固定向量和向量外一点$S$可以确定一正交的平面，该平面与向量（直线）的交点才是实际的圆心

    $$\vec{P_{c_1}} = \vec{P_s} + \vec{SC_1}$$
    $$\vec{C_1C} = -\vec{P_{c_1}} \cdot \hat Z$$
    $$\vec{P_c} = \vec{P_{c_1}} + \vec{C_1C}$$

2. 构造圆心坐标系

    将旋转轴$\hat Z$确定为点$C$处的Z轴，将向量$\vec{CS}$定义为X轴， Y轴由正交获得。

3. 确定末端点E齐次变换矩阵

    C点相对于S点的齐次变换：

    $$T_S^C = T_C^{-1}T_S$$
    $$T_E = T_C \cdot R_Z(\theta) \cdot T_S^C$$

    通过改变$\theta$可以确定轨迹中的过程点位姿，如果不允许运动过程中末端姿态发生改变，可直接将其中的旋转矩阵替换为$R_s$

##### 二. 给定空间内三点，确定圆弧轨迹

这种方法比较直观，对于UI轨迹规划和简单避障的情况下适合采用这种方法。

1. 已知空间点S、 M、 E，求中心点C

2. 确定旋转轴Z

    $$\hat Z = \vec{SM} \times \vec{SE}$$

3. 确定旋转角$\theta$

    在$\Delta SCE$中由余弦定理可求得$∠C \in [0, \pi)$

    ①参考轴$axis = \vec{SE} \times \vec{SC}$

    通过确定该向量是否与Z轴同向判断旋转角$\theta$取小角度$∠C$还是$2\pi - ∠C$

    ②由于$∠SME\in[0, \pi)$，故可以通过判断该角是锐角还是钝角确定$\theta$取小角度$∠C$还是$2\pi - ∠C$
